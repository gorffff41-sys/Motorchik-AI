# Отчет: Умный роутер запросов

## Описание

Создан умный роутер запросов (`SmartQueryRouter`), который автоматически разделяет запросы на два типа:

1. **Автомобильные запросы** - отправляются в текущую систему обработки автомобилей
2. **Общие запросы** - отправляются напрямую в LLAMA

## Функциональность

### Классификация запросов

Роутер использует систему ключевых слов для определения типа запроса:

#### Автомобильные ключевые слова:
- Бренды автомобилей (BMW, Mercedes, Toyota, Honda, и т.д.)
- Автомобильные термины (машина, двигатель, кузов, салон, и т.д.)
- Действия с автомобилями (купить, продать, найти, сравнить, и т.д.)
- Типы автомобилей (седан, внедорожник, кабриолет, и т.д.)
- Цвета (красный, синий, белый, и т.д.)
- Технические характеристики (бензин, дизель, автомат, и т.д.)
- Ценовые категории (миллионов, тысяч, рублей, и т.д.)

#### Общие ключевые слова:
- Приветствия и общение (привет, как дела, кто ты, и т.д.)
- Погода и природа (погода, температура, дождь, и т.д.)
- Время и дата (время, часы, дата, сегодня, и т.д.)
- Математика и вычисления (посчитай, вычисли, математика, и т.д.)
- Развлечения и хобби (игра, музыка, фильм, и т.д.)

### Эвристики

Для случаев, когда ключевые слова не дают однозначного ответа, используются эвристики:

- Запросы с вопросами о характеристиках → автомобильные
- Запросы с вопросами о цене → автомобильные  
- Запросы с вопросами о поиске/выборе → автомобильные
- Запросы с приветствиями → общие
- Запросы о погоде → общие
- Запросы о времени → общие
- Запросы о математике → общие
- Запросы о себе/системе → общие

## API Интеграция

### Новый endpoint: `/api/smart-chat`

```python
@app.post("/api/smart-chat")
async def smart_chat(request: ChatRequest):
    """Умный чат с автоматической маршрутизацией запросов"""
    try:
        from smart_query_router import route_query
        
        # Маршрутизируем запрос
        result = route_query(request.message, request.user_id)
        
        return JSONResponse(content=result)
        
    except Exception as e:
        logger.error(f"Ошибка в умном чате: {str(e)}")
        return JSONResponse(content={
            "success": False,
            "error": "Ошибка обработки запроса",
            "message": "Извините, произошла ошибка при обработке вашего запроса."
        })
```

### Структура ответа

```json
{
    "success": true,
    "is_car_query": true/false,
    "data": {...},
    "message": "Запрос обработан автомобильной системой/LLAMA"
}
```

## Тестирование

### Результаты тестирования

Протестировано 16 различных запросов:

#### Автомобильные запросы (6):
- ✅ "найди BMW X5"
- ✅ "покажи красные машины"
- ✅ "сравни Toyota Camry и Honda Accord"
- ✅ "какая цена на Mercedes"
- ✅ "посоветуй семейный автомобиль"
- ✅ "найди машину до 2 миллионов"

#### Общие запросы (10):
- ✅ "привет, как дела?"
- ✅ "какая погода в Москве?"
- ✅ "кто ты?"
- ✅ "расскажи анекдот"
- ✅ "сколько времени?"
- ✅ "как дела?"
- ✅ "что ты умеешь?"
- ✅ "какая сегодня дата?"
- ✅ "посчитай 2+2"
- ✅ "расскажи о себе"

### Точность классификации: 100%

## Использование

### Пример использования в коде:

```python
from smart_query_router import route_query

# Автомобильный запрос
result = route_query("найди BMW X5", "user123")
# Результат: отправляется в автомобильную систему

# Общий запрос  
result = route_query("привет, как дела?", "user123")
# Результат: отправляется в LLAMA
```

### Пример HTTP запроса:

```bash
curl -X POST "http://localhost:8000/api/smart-chat" \
     -H "Content-Type: application/json" \
     -d '{"message": "найди BMW X5", "user_id": "user123"}'
```

## Преимущества

1. **Автоматическая маршрутизация** - не нужно вручную определять тип запроса
2. **Высокая точность** - 100% точность классификации в тестах
3. **Расширяемость** - легко добавлять новые ключевые слова
4. **Интеграция** - работает с существующей системой
5. **Обработка ошибок** - корректная обработка исключений

## Файлы

- `smart_query_router.py` - основной класс роутера
- `test_simple_smart_router.py` - тесты классификации
- `test_smart_router_integration.py` - тесты интеграции с API
- `smart_router_report.md` - данный отчет

## Заключение

Умный роутер запросов успешно создан и протестирован. Он обеспечивает автоматическое разделение запросов с высокой точностью и готов к интеграции в основную систему. 