# Отчет об исправлении сравнения с множественными марками

## Проблема
При запросе "Сравни BMW X3 и Haval Jolion" система извлекала только первую марку (BMW) и игнорировала вторую (Haval). Это происходило из-за неправильной логики извлечения сущностей в NER классификаторе.

## Исправления

### 1. Обновление NER классификатора (`modules/classifiers/ner_intent_classifier.py`)

**Проблема**: Логика извлечения марок не поддерживала составные названия в запросах сравнения.

**Исправления**:
- Добавлены новые паттерны для поиска составных названий:
  ```python
  comparison_patterns = [
      r'([a-zA-Z]+)\s+([a-zA-Z0-9]+)\s+и\s+([a-zA-Z]+)\s+([a-zA-Z0-9]+)',  # BMW X3 и Haval Jolion
      r'([a-zA-Z]+)\s+([a-zA-Z0-9]+)\s+или\s+([a-zA-Z]+)\s+([a-zA-Z0-9]+)',  # BMW X3 или Haval Jolion
      r'([a-zA-Z]+)\s+([a-zA-Z0-9]+),\s*([a-zA-Z]+)\s+([a-zA-Z0-9]+)',  # BMW X3, Haval Jolion
  ]
  ```

- Исправлена обработка множественных марок с приведением к нижнему регистру
- Добавлена проверка на корректность типов данных (списки vs множества)

### 2. Обновление компаратора (`modules/comparators/car_comparator.py`)

**Проблема**: Метод `compare_by_names` обрабатывал только первую пару и игнорировал остальные.

**Исправления**:
- Изменена логика обработки найденных автомобилей:
  ```python
  # Берем несколько автомобилей для каждой пары (не только первый)
  for i, car in enumerate(filtered_cars[:5]):  # Ограничиваем до 5 машин на пару
      car['comparison_name'] = f"{brand} {model}".strip()
      found_cars.append(car)
  ```

### 3. Обновление процессора поиска (`modules/search/auto_search_processor.py`)

**Добавлено**:
- Дополнительная информация о типе сравнения в результатах
- Улучшенная обработка ошибок

## Результаты тестирования

### До исправления:
- ❌ "Сравни BMW X3 и Haval Jolion" → извлекалась только BMW
- ❌ SQL-запросы показывали только `['%bmw%', '%bmw%']`

### После исправления:
- ✅ "Сравни BMW X3 и Haval Jolion" → извлекаются обе марки: BMW и Haval
- ✅ "Сравни BMW X3 или Haval Jolion" → извлекаются обе марки
- ✅ "Сравни BMW X3, Haval Jolion" → извлекаются обе марки
- ✅ "Сравни BMW и Haval" → извлекаются обе марки
- ✅ "Сравни BMW X3 и Audi A4" → извлекаются обе марки
- ✅ "Сравни Mercedes C200 и BMW X5" → извлекаются обе марки

## Тестовые файлы

1. `test_comparison_fix.py` - тест извлечения сущностей
2. `test_comparison_full.py` - полный тест функциональности сравнения
3. `test_final_comparison_fix.py` - финальный тест с множественными марками

## Статус

✅ **ИСПРАВЛЕНО**: Система теперь правильно извлекает и обрабатывает множественные марки в запросах сравнения.

## Следующие шаги

1. Протестировать в реальном интерфейсе
2. Проверить отображение результатов сравнения в frontend
3. Убедиться, что таблица сравнения корректно отображает машины обеих марок 