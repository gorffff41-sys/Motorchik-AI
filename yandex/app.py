from flask import Flask, render_template, request, jsonify
from flask_cors import CORS
import os
import json
import requests
from datetime import datetime
import wikipedia
from dotenv import load_dotenv
import torch
from transformers import AutoModelForCausalLM, AutoTokenizer
import threading
import queue
import re
import math

load_dotenv()

app = Flask(__name__)
CORS(app)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
MODEL_NAME = "yandex/YandexGPT-5-Lite-8B-instruct"
WEATHER_API_KEY = os.getenv('WEATHER_API_KEY', 'your_weather_api_key')
NEWS_API_KEY = os.getenv('NEWS_API_KEY', 'your_news_api_key')
EXCHANGE_API_KEY = os.getenv('EXCHANGE_API_KEY', 'your_exchange_api_key')

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–µ–ª–∏
model = None
tokenizer = None
model_loaded = False

def load_model():
    """–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ Yandex GPT –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ"""
    global model, tokenizer, model_loaded
    try:
        print("–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ Yandex GPT...")
        tokenizer = AutoTokenizer.from_pretrained(MODEL_NAME)
        model = AutoModelForCausalLM.from_pretrained(
            MODEL_NAME,
            device_map="auto",
            torch_dtype="auto",
        )
        model_loaded = True
        print("–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: {e}")
        model_loaded = False

# –ó–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ –≤ —Ñ–æ–Ω–µ
threading.Thread(target=load_model, daemon=True).start()

def get_weather(city):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ–≥–æ–¥—ã"""
    try:
        url = f"http://api.openweathermap.org/data/2.5/weather"
        params = {
            'q': city,
            'appid': WEATHER_API_KEY,
            'units': 'metric',
            'lang': 'ru'
        }
        response = requests.get(url, params=params)
        if response.status_code == 200:
            data = response.json()
            weather_info = {
                'city': data['name'],
                'temperature': round(data['main']['temp']),
                'feels_like': round(data['main']['feels_like']),
                'description': data['weather'][0]['description'],
                'humidity': data['main']['humidity'],
                'wind_speed': data['wind']['speed'],
                'pressure': data['main']['pressure']
            }
            return weather_info
        else:
            return None
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã: {e}")
        return None

def get_news(query="–Ω–æ–≤–æ—Å—Ç–∏"):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π"""
    try:
        url = "https://newsapi.org/v2/everything"
        params = {
            'q': query,
            'apiKey': NEWS_API_KEY,
            'language': 'ru',
            'sortBy': 'publishedAt',
            'pageSize': 5
        }
        response = requests.get(url, params=params)
        if response.status_code == 200:
            data = response.json()
            articles = []
            for article in data.get('articles', []):
                articles.append({
                    'title': article['title'],
                    'description': article['description'],
                    'url': article['url'],
                    'publishedAt': article['publishedAt']
                })
            return articles
        else:
            return []
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ—Å—Ç–µ–π: {e}")
        return []

def get_wikipedia_info(query):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ Wikipedia"""
    try:
        wikipedia.set_lang('ru')
        # –ü–æ–∏—Å–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        search_results = wikipedia.search(query, results=3)
        if search_results:
            page = wikipedia.page(search_results[0])
            summary = wikipedia.summary(search_results[0], sentences=3)
            return {
                'title': page.title,
                'summary': summary,
                'url': page.url
            }
        else:
            return None
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ Wikipedia: {e}")
        return None

def calculate_expression(expression):
    """–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π"""
    try:
        # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä, –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ —Å–∫–æ–±–æ–∫
        clean_expr = re.sub(r'[^0-9+\-*/().]', '', expression)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏—è
        if not re.match(r'^[0-9+\-*/().\s]+$', clean_expr):
            return None, "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏–∏"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å —Å–∫–æ–±–æ–∫
        if clean_expr.count('(') != clean_expr.count(')'):
            return None, "–ù–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∫–æ–±–∫–∏"
        
        # –í—ã—á–∏—Å–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        result = eval(clean_expr)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å
        if not math.isfinite(result):
            return None, "–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π"
        
        return result, None
    except Exception as e:
        return None, f"–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è: {str(e)}"

def convert_currency(amount, from_currency, to_currency):
    """–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç"""
    try:
        # –ü—Ä–æ—Å—Ç—ã–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ API)
        rates = {
            'USD': {'RUB': 95.0, 'EUR': 0.85, 'CNY': 6.5},
            'EUR': {'RUB': 112.0, 'USD': 1.18, 'CNY': 7.65},
            'RUB': {'USD': 0.0105, 'EUR': 0.0089, 'CNY': 0.068},
            'CNY': {'USD': 0.154, 'EUR': 0.131, 'RUB': 14.7}
        }
        
        if from_currency == to_currency:
            return amount
        
        if from_currency in rates and to_currency in rates[from_currency]:
            return round(amount * rates[from_currency][to_currency], 2)
        else:
            return None
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤–∞–ª—é—Ç: {e}")
        return None

def translate_text(text, target_lang='en'):
    """–ü—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ API)"""
    try:
        # –ü—Ä–æ—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        translations = {
            '–ø—Ä–∏–≤–µ—Ç': 'hello',
            '–ø–æ–∫–∞': 'goodbye',
            '—Å–ø–∞—Å–∏–±–æ': 'thank you',
            '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞': 'please',
            '–¥–∞': 'yes',
            '–Ω–µ—Ç': 'no'
        }
        
        if target_lang == 'en':
            return translations.get(text.lower(), f"[–ü–µ—Ä–µ–≤–æ–¥: {text}]")
        else:
            return f"[–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ {target_lang}: {text}]"
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: {e}")
        return None

def generate_yandex_response(messages):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —Å –ø–æ–º–æ—â—å—é Yandex GPT"""
    global model, tokenizer, model_loaded
    
    if not model_loaded:
        return "–ú–æ–¥–µ–ª—å –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ..."
    
    try:
        input_ids = tokenizer.apply_chat_template(
            messages, tokenize=True, return_tensors="pt"
        )
        
        if torch.cuda.is_available():
            input_ids = input_ids.to("cuda")
        
        with torch.no_grad():
            outputs = model.generate(
                input_ids, 
                max_new_tokens=1024,
                temperature=0.7,
                top_p=0.9,
                do_sample=True
            )
        
        response = tokenizer.decode(
            outputs[0][input_ids.size(1):], 
            skip_special_tokens=True
        )
        return response.strip()
    
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: {e}")
        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞."

def process_message(message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞"""
    message_lower = message.lower()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–æ–≥–æ–¥—ã
    weather_keywords = ['–ø–æ–≥–æ–¥–∞', '–ø–æ–≥–æ–¥—É', '—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞', '–∫–ª–∏–º–∞—Ç']
    if any(keyword in message_lower for keyword in weather_keywords):
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
        words = message.split()
        city = None
        for i, word in enumerate(words):
            if word.lower() in weather_keywords:
                if i + 1 < len(words):
                    city = words[i + 1]
                break
        
        if not city:
            city = "–ú–æ—Å–∫–≤–∞"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
        
        weather = get_weather(city)
        if weather:
            return {
                'type': 'weather',
                'content': weather,
                'message': f"üå§Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã –¥–ª—è {weather['city']}:\n"
                          f"üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {weather['temperature']}¬∞C\n"
                          f"üå°Ô∏è –û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫: {weather['feels_like']}¬∞C\n"
                          f"‚òÅÔ∏è –û–ø–∏—Å–∞–Ω–∏–µ: {weather['description']}\n"
                          f"üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: {weather['humidity']}%\n"
                          f"üí® –í–µ—Ç–µ—Ä: {weather['wind_speed']} –º/—Å\n"
                          f"üå°Ô∏è –î–∞–≤–ª–µ–Ω–∏–µ: {weather['pressure']} –≥–ü–∞"
            }
        else:
            return {
                'type': 'error',
                'content': '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã'
            }
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å –Ω–æ–≤–æ—Å—Ç–µ–π
    news_keywords = ['–Ω–æ–≤–æ—Å—Ç–∏', '–Ω–æ–≤–æ—Å—Ç—å', '—Å–æ–±—ã—Ç–∏—è', '–ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è']
    if any(keyword in message_lower for keyword in news_keywords):
        news = get_news()
        if news:
            news_text = "üì∞ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏:\n\n"
            for i, article in enumerate(news, 1):
                news_text += f"{i}. {article['title']}\n"
                news_text += f"   {article['description']}\n"
                news_text += f"   üìÖ {article['publishedAt'][:10]}\n\n"
            
            return {
                'type': 'news',
                'content': news,
                'message': news_text
            }
        else:
            return {
                'type': 'error',
                'content': '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏'
            }
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ Wikipedia
    wiki_keywords = ['—á—Ç–æ —Ç–∞–∫–æ–µ', '–∫—Ç–æ —Ç–∞–∫–æ–π', '–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ', '–≤–∏–∫–∏–ø–µ–¥–∏—è']
    if any(keyword in message_lower for keyword in wiki_keywords):
        query = message.replace('—á—Ç–æ —Ç–∞–∫–æ–µ', '').replace('–∫—Ç–æ —Ç–∞–∫–æ–π', '').replace('–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ', '').replace('–≤–∏–∫–∏–ø–µ–¥–∏—è', '').strip()
        wiki_info = get_wikipedia_info(query)
        if wiki_info:
            return {
                'type': 'wikipedia',
                'content': wiki_info,
                'message': f"üìö {wiki_info['title']}\n\n{wiki_info['summary']}\n\nüîó –ü–æ–¥—Ä–æ–±–Ω–µ–µ: {wiki_info['url']}"
            }
        else:
            return {
                'type': 'error',
                'content': '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ Wikipedia'
            }
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
    calc_patterns = [
        r'–ø–æ—Å—á–∏—Ç–∞–π\s+(.+)',
        r'–≤—ã—á–∏—Å–ª–∏\s+(.+)',
        r'—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç\s+(.+)',
        r'–≤—ã—á–∏—Å–ª–∏—Ç—å\s+(.+)'
    ]
    
    for pattern in calc_patterns:
        match = re.search(pattern, message_lower)
        if match:
            expression = match.group(1)
            result, error = calculate_expression(expression)
            if result is not None:
                return {
                    'type': 'calculator',
                    'content': {'expression': expression, 'result': result},
                    'message': f"üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä:\n{expression} = {result}"
                }
            else:
                return {
                    'type': 'error',
                    'content': error
                }
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç
    currency_patterns = [
        r'(\d+(?:\.\d+)?)\s*(usd|—Ä—É–±|—Ä—É–±–ª–µ–π|–¥–æ–ª–ª–∞—Ä|–¥–æ–ª–ª–∞—Ä–æ–≤)\s*(?:–≤|to)\s*(rub|—Ä—É–±|—Ä—É–±–ª–µ–π|usd|–¥–æ–ª–ª–∞—Ä|–¥–æ–ª–ª–∞—Ä–æ–≤)',
        r'–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π\s+(\d+(?:\.\d+)?)\s*(usd|—Ä—É–±|—Ä—É–±–ª–µ–π|–¥–æ–ª–ª–∞—Ä|–¥–æ–ª–ª–∞—Ä–æ–≤)\s*(?:–≤|to)\s*(rub|—Ä—É–±|—Ä—É–±–ª–µ–π|usd|–¥–æ–ª–ª–∞—Ä|–¥–æ–ª–ª–∞—Ä–æ–≤)'
    ]
    
    for pattern in currency_patterns:
        match = re.search(pattern, message_lower)
        if match:
            amount = float(match.group(1))
            from_curr = match.group(2)
            to_curr = match.group(3)
            
            # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–∞–ª—é—Ç
            if from_curr in ['—Ä—É–±', '—Ä—É–±–ª–µ–π']:
                from_curr = 'RUB'
            elif from_curr in ['–¥–æ–ª–ª–∞—Ä', '–¥–æ–ª–ª–∞—Ä–æ–≤', 'usd']:
                from_curr = 'USD'
            
            if to_curr in ['—Ä—É–±', '—Ä—É–±–ª–µ–π']:
                to_curr = 'RUB'
            elif to_curr in ['–¥–æ–ª–ª–∞—Ä', '–¥–æ–ª–ª–∞—Ä–æ–≤', 'usd']:
                to_curr = 'USD'
            
            result = convert_currency(amount, from_curr, to_curr)
            if result is not None:
                return {
                    'type': 'currency',
                    'content': {'amount': amount, 'from': from_curr, 'to': to_curr, 'result': result},
                    'message': f"üí± –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç:\n{amount} {from_curr} = {result} {to_curr}"
                }
            else:
                return {
                    'type': 'error',
                    'content': '–ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∞–ª—é—Ç—É'
                }
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫
    translate_patterns = [
        r'–ø–µ—Ä–µ–≤–µ–¥–∏\s+(.+)',
        r'–ø–µ—Ä–µ–≤–æ–¥\s+(.+)',
        r'translate\s+(.+)'
    ]
    
    for pattern in translate_patterns:
        match = re.search(pattern, message_lower)
        if match:
            text = match.group(1).strip()
            translation = translate_text(text)
            if translation:
                return {
                    'type': 'translator',
                    'content': {'original': text, 'translation': translation},
                    'message': f"üåê –ü–µ—Ä–µ–≤–æ–¥:\n{text} ‚Üí {translation}"
                }
            else:
                return {
                    'type': 'error',
                    'content': '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç'
                }
    
    # –û–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ Yandex GPT
    return {
        'type': 'gpt',
        'content': None,
        'message': None
    }

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/chat', methods=['POST'])
def chat():
    try:
        data = request.get_json()
        message = data.get('message', '')
        
        if not message:
            return jsonify({'error': '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'}), 400
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        result = process_message(message)
        
        if result['type'] == 'gpt':
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º Yandex GPT
            messages = [{"role": "user", "content": message}]
            response = generate_yandex_response(messages)
            
            return jsonify({
                'type': 'gpt',
                'message': response,
                'timestamp': datetime.now().isoformat()
            })
        
        elif result['type'] in ['weather', 'news', 'wikipedia', 'calculator', 'currency', 'translator']:
            return jsonify({
                'type': result['type'],
                'message': result['message'],
                'data': result['content'],
                'timestamp': datetime.now().isoformat()
            })
        
        else:
            return jsonify({
                'type': 'error',
                'message': result['content'],
                'timestamp': datetime.now().isoformat()
            })
    
    except Exception as e:
        return jsonify({
            'error': f'–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}'
        }), 500

@app.route('/api/status')
def status():
    return jsonify({
        'model_loaded': model_loaded,
        'timestamp': datetime.now().isoformat()
    })

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000) 