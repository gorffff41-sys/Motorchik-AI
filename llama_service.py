import requests
import json
import logging
import time
from typing import Dict, Any, Optional
from config import LLAMA_API_URL, LLAMA_API_KEY

logger = logging.getLogger("llama_service")

LLAMA_URLS = [
    "http://127.0.0.1:11434/api/generate",
    "http://localhost:11434/api/generate"
]
RETRY_ATTEMPTS = 3
RETRY_BASE_DELAY = 2  # seconds

# ÐŸÑ€Ð¾Ð¼Ñ‚ Ð´Ð»Ñ ÐœÐ¾Ñ‚Ð¾Ñ€Ñ‡Ð¸ÐºÐ° - Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚Ð°
MOTORCHIK_PROMPT = """
Ð¢Ñ‹ - ÐœÐ¾Ñ‚Ð¾Ñ€Ñ‡Ð¸Ðº, ÑƒÐ¼Ð½Ñ‹Ð¹ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚, ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð´Ð»Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼ Ð² Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ñ…, ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ñ… Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑÐ¼Ð¸, Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¾Ð¹, Ð¿Ñ€Ð¾Ð´Ð°Ð¶ÐµÐ¹, Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð¸ Ð²ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÐºÐ°ÑÐ°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ¸.

## Ð¢Ð²Ð¾Ñ Ñ€Ð¾Ð»ÑŒ Ð¸ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸:

### ðŸš— ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ:
- ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ Ð² Ð²Ñ‹Ð±Ð¾Ñ€Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÐµÐ¹
- Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸Ðº Ð¼Ð°ÑˆÐ¸Ð½
- ÐšÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐµ Ð¸ Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ðµ
- Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸Ð¸ Ð¸ Ñ€ÐµÐ¼Ð¾Ð½Ñ‚Ðµ
- Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð½Ð° Ð´Ð¾Ñ€Ð¾Ð³Ðµ
- Ð¡Ð¾Ð²ÐµÑ‚Ñ‹ Ð¿Ð¾ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ð¸ Ñ‚Ð¾Ð¿Ð»Ð¸Ð²Ð°
- ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ð¸ ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²ÐºÐ¾Ð¹

### ðŸ’¡ Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸:
- ÐžÐ±Ñ‰Ð¸Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¸ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°
- ÐžÐ±ÑŠÑÑÐ½ÐµÐ½Ð¸Ðµ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð¾Ð²
- Ð¡Ð¾Ð²ÐµÑ‚Ñ‹ Ð¿Ð¾ ÑƒÑ…Ð¾Ð´Ñƒ Ð·Ð° Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÐµÐ¼
- Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð½Ð¾Ð²Ñ‹Ñ… Ñ‚ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸ÑÑ… Ð² Ð°Ð²Ñ‚Ð¾Ð¸Ð½Ð´ÑƒÑÑ‚Ñ€Ð¸Ð¸
- ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ Ñ Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð¿Ð¾ÐµÐ·Ð´Ð¾Ðº

## Ð¡Ñ‚Ð¸Ð»ÑŒ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:
- Ð”Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹ Ð¸ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹
- ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ð¹ Ð¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹
- ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð¸ Ð¿Ð¾ Ð´ÐµÐ»Ñƒ: 2â€“4 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ, Ð±ÐµÐ· Ð»Ð¸ÑˆÐ½ÐµÐ¹ Ð²Ð¾Ð´Ñ‹
- ÐÐµ Ð½Ð°Ñ‡Ð¸Ð½Ð°Ð¹ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ñ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ñ; Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ ÑƒÐ¼ÐµÑÑ‚Ð½Ð¾
- ÐŸÐ¾Ð¾Ñ‰Ñ€ÑÐ¹ ÑƒÑ‚Ð¾Ñ‡Ð½ÐµÐ½Ð¸Ñ ÐºÑ€Ð°Ñ‚ÐºÐ¸Ð¼ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð¼ Ð² ÐºÐ¾Ð½Ñ†Ðµ

## ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° Ð²Ð·Ð°Ð¸Ð¼Ð¾Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ:
- Ð¢Ñ‹ â€” Ð°Ð²Ñ‚Ð¾Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ ÐÐÐ ÐœÐžÐ¢ÐžÐ Ð¡ (Ð½Ð¾ Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð¾ Ð²ÑÐµÐ³Ð´Ð° Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ)
- ÐžÐ±Ñ€Ð°Ñ‰Ð°Ð¹ÑÑ Ð½Ð° "Ð’Ñ‹" Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð±ÑƒÐºÐ²Ñ‹; Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ "Ð’Ð°Ñ", "Ð’Ð°Ð¼", "Ð’Ð°Ñˆ"
- ÐÐ¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ„Ð¾Ñ€Ð¼Ñ‹ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ Ð½Ð° Â«Ñ‚Ñ‹Â» (Ñ‚Ñ‹/Ñ‚ÐµÐ±Ñ/Ñ‚ÐµÐ±Ðµ/Ñ‚Ð²Ð¾Ð¹/Ñ‚Ð¾Ð±Ð¾Ð¹ Ð¸ Ñ‚.Ð´.)
- ÐŸÑ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ Ð¸ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ ÑˆÐ°Ð³
- Ð—Ð°Ð´Ð°Ð²Ð°Ð¹ Ð¾Ð´Ð¸Ð½ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹ ÑƒÑ‚Ð¾Ñ‡Ð½ÑÑŽÑ‰Ð¸Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð² ÐºÐ¾Ð½Ñ†Ðµ
- Ð”Ð°Ð²Ð°Ð¹ Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑÐ¾Ð²ÐµÑ‚Ñ‹
- Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ ÐºÑ€Ð°Ñ‚ÐºÐ¸Ð¼Ð¸
- Ð’ÑÐµÐ³Ð´Ð° Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¿Ð¸ÑˆÐµÑ‚ Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð¼

## ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:

### ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÑƒÐ¼ÐµÑÑ‚Ð½Ð¾):
"Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ! Ð§ÐµÐ¼ Ð¼Ð¾Ð³Ñƒ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ñ Ð¿Ð¾Ð´Ð±Ð¾Ñ€Ð¾Ð¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»Ñ?"

### Ðž ÑÐµÐ±Ðµ (ÐºÑ€Ð°Ñ‚ÐºÐ¾):
"Ð¯ Ð°Ð²Ñ‚Ð¾Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÐÐÐ ÐœÐžÐ¢ÐžÐ Ð¡. ÐŸÐ¾Ð¼Ð¾Ð³Ð°ÑŽ Ñ Ð¿Ð¾Ð´Ð±Ð¾Ñ€Ð¾Ð¼ Ð°Ð²Ñ‚Ð¾, ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸ÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ Ð¸ ÑÐ¾Ð²ÐµÑ‚Ð°Ð¼Ð¸ Ð¿Ð¾ Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸ÑŽ."

### Ðž Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑÑ… (ÐºÑ€Ð°Ñ‚ÐºÐ¾):
"ÐœÐ¾Ð³Ñƒ Ð¿Ð¾Ð´Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾ Ð¿Ð¾Ð´ Ð’Ð°ÑˆÐ¸ ÐºÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¸, ÑÑ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¸ Ð¿Ð¾Ð´ÑÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ð¾ ÐºÑ€ÐµÐ´Ð¸Ñ‚Ñƒ/ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ð½Ð¸ÑŽ. ÐšÐ°ÐºÐ¸Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð²Ð°Ð¶Ð½Ñ‹?"

### Ð¢Ð²Ð¾Ñ€Ñ‡ÐµÑÐºÐ¸Ðµ/Ð¸Ð³Ñ€Ð¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Â«Ð¼Ð°ÑˆÐ¸Ð½Ð° ÐºÐ°Ðº Ñƒ Ð‘ÑÑ‚Ð¼ÐµÐ½Ð°Â»):
- ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð² ÑÐµÑ€ÑŒÐµÐ·Ð½Ð¾Ð¼, Ð´ÐµÐ»Ð¾Ð²Ð¾Ð¼ ÑÑ‚Ð¸Ð»Ðµ
- Ð”Ð°Ð¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ðµ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸ (3â€“5 Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹) Ñ ÐºÑ€Ð°Ñ‚ÐºÐ¸Ð¼ Ð¾Ð±Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ (1 ÑÑ‚Ñ€Ð¾ÐºÐ° Ð½Ð° Ð¼Ð¾Ð´ÐµÐ»ÑŒ)
- Ð‘ÐµÐ· ÑŽÐ¼Ð¾Ñ€Ð° Ð¸ Ð±ÐµÐ· Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ñ… ÑÑ‚Ð¸Ð»ÐµÐ²Ñ‹Ñ… Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð¾Ð²
- Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸ Ð¾Ð´Ð½Ð¸Ð¼ ÐºÑ€Ð°Ñ‚ÐºÐ¸Ð¼ ÑƒÑ‚Ð¾Ñ‡Ð½ÑÑŽÑ‰Ð¸Ð¼ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð¼ Ð¾ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð°Ñ… (Ð¼Ð¾Ñ‰Ð½Ð¾ÑÑ‚ÑŒ/Ð´Ð¸Ð·Ð°Ð¹Ð½/Ñ‚ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ð¾ÑÑ‚ÑŒ/Ð±ÑŽÐ´Ð¶ÐµÑ‚)

ÐŸÐ¾Ð¼Ð½Ð¸, Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ - Ð°Ð²Ñ‚Ð¾Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ ÐÐÐ ÐœÐžÐ¢ÐžÐ Ð¡, ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚. Ð¢Ð²Ð¾Ñ Ð³Ð»Ð°Ð²Ð½Ð°Ñ Ñ†ÐµÐ»ÑŒ - Ð¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼ Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ¾Ð¹, Ð½Ð¾ Ñ‚Ñ‹ Ñ‚Ð°ÐºÐ¶Ðµ Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ñ‚ÑŒ Ð´Ñ€ÑƒÐ¶ÐµÑÐºÑƒÑŽ Ð±ÐµÑÐµÐ´Ñƒ Ð¸ Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ñ‚ÑŒ Ð½Ð° Ð¾Ð±Ñ‰Ð¸Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹. Ð’ÑÐµÐ³Ð´Ð° Ð±ÑƒÐ´ÑŒ Ð¿Ð¾Ð»ÐµÐ·Ð½Ñ‹Ð¼, Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¼ Ð¸ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¼!

Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚ÑŒ Ð½Ð° Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² ÑÑ‚Ð¸Ð»Ðµ ÐœÐ¾Ñ‚Ð¾Ñ€Ñ‡Ð¸ÐºÐ°. ÐŸÐ¾Ð¼Ð½Ð¸: ÐºÑ€Ð°Ñ‚ÐºÐ¾ÑÑ‚ÑŒ, Ð±ÐµÐ· Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ñ, Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹, ÐµÑÐ»Ð¸ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ‚Ð²Ð¾Ñ€Ñ‡ÐµÑÐºÐ¸Ð¹:
"""


def check_llama_status():
    """ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚, Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð»Ð¸ Ollama/LLAMA Ð½Ð° Ð¾Ð´Ð½Ð¾Ð¼ Ð¸Ð· LLAMA_URLS"""
    for base_url in ["http://127.0.0.1:11434", "http://localhost:11434"]:
        try:
            resp = requests.get(base_url, timeout=2)
            if resp.status_code == 200 or resp.status_code == 404:
                return True
        except Exception:
            continue
    return False

def postprocess_llama_response(text):
    """
    Ð—Ð°Ð¼ÐµÐ½ÑÐµÑ‚ ÐºÐ¾Ð´Ñ‹ Ð¾Ð¿Ñ†Ð¸Ð¹ Ð²Ð¸Ð´Ð° `optXXXX` Ð½Ð° Ð¸Ñ… Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ Ð¸Ð· Ð±Ð°Ð·Ñ‹.
    """
    import re
    from database import get_all_options
    options = get_all_options()
    code2desc = {o['code']: o['description'] for o in options if o['code']}
    def repl(match):
        code = match.group(1)
        desc = code2desc.get(code)
        return f"`{desc}`" if desc else f"`{code}`"
    return re.sub(r'`(opt\d{4,})`', repl, text)

def generate_with_llama(prompt: str, context: Optional[Dict] = None) -> str:
    """Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Llama Ñ retry-Ð»Ð¾Ð³Ð¸ÐºÐ¾Ð¹ Ð¸ fallback Ð¿Ð¾ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ð¼ Ð°Ð´Ñ€ÐµÑÐ°Ð¼"""
    payload = {
        "model": "llama3:8b",
        "prompt": prompt,
        "stream": False
    }
    if context:
        payload["context"] = context
    last_error = None
    for url in LLAMA_URLS:
        for attempt in range(RETRY_ATTEMPTS):
            try:
                response = requests.post(url, json=payload, timeout=90)
                if response.status_code == 200:
                    result = response.json()
                    return result.get("response", "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹...")
                else:
                    last_error = f"ÐžÑˆÐ¸Ð±ÐºÐ° Llama API: {response.status_code} ({url})"
            except Exception as e:
                last_error = f"{e} ({url})"
            time.sleep(RETRY_BASE_DELAY * (2 ** attempt))
    # Fallback: Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    return "Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹..."

def generate_general_response(user_query: str) -> str:
    """Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ð° Ð¾Ð±Ñ‰Ð¸Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð² ÑÑ‚Ð¸Ð»Ðµ ÐœÐ¾Ñ‚Ð¾Ñ€Ñ‡Ð¸ÐºÐ°"""
    full_prompt = f"{MOTORCHIK_PROMPT}\n\nÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: {user_query}\n\nÐ’Ð°Ð¶Ð½Ð¾: Ð¾Ñ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ. ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº.\n\nÐœÐ¾Ñ‚Ð¾Ñ€Ñ‡Ð¸Ðº:"
    
    try:
        raw = generate_with_llama(full_prompt)
        # Ð•ÑÐ»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ðµ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ñ„Ð¾Ñ€ÑÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·
        if not _looks_russian(raw):
            forced_prompt = full_prompt + "\n\nÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ: Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹Ñ‚Ðµ Ð¢ÐžÐ›Ð¬ÐšÐž Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ."
            raw = generate_with_llama(forced_prompt)
        # ÐŸÑ€Ð¸Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ Ðº Ñ„Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¼Ñƒ (Ð’Ñ‹/Ð’Ð°Ð¼/Ð’Ð°Ñ/Ð’Ð°Ñˆ)
        raw = enforce_formal_address(raw)
        return raw
    except Exception as e:
        logger.error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¾Ð±Ñ‰ÐµÐ³Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð°: {e}")
        # Fallback Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ Ð´Ð»Ñ Ñ‚Ð¸Ð¿Ð¸Ñ‡Ð½Ñ‹Ñ… Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð²
        fallback_responses = {
            "Ð¿Ñ€Ð¸Ð²ÐµÑ‚": "Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ! Ð¯ Ð°Ð²Ñ‚Ð¾Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ ÐÐÐ ÐœÐžÐ¢ÐžÐ Ð¡. Ð“Ð¾Ñ‚Ð¾Ð² Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ð’Ð°Ð¼ Ñ Ð»ÑŽÐ±Ñ‹Ð¼Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸ Ð¿Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑÐ¼ - Ð¾Ñ‚ Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð¼Ð°ÑˆÐ¸Ð½Ñ‹ Ð´Ð¾ ÑÐ¾Ð²ÐµÑ‚Ð¾Ð² Ð¿Ð¾ Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸ÑŽ. Ð§Ñ‚Ð¾ Ð’Ð°Ñ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÐµÑ‚?",
            "ÐºÑ‚Ð¾ Ñ‚Ñ‹": "Ð¯ Ð°Ð²Ñ‚Ð¾Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ ÐÐÐ ÐœÐžÐ¢ÐžÐ Ð¡ - ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð˜Ð˜-Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ¸. ÐœÐ¾Ñ Ð³Ð»Ð°Ð²Ð½Ð°Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° - Ð¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ð»ÑŽÐ´ÑÐ¼ Ñ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸, ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑÐ¼Ð¸. Ð¯ Ð¼Ð¾Ð³Ñƒ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ð’Ð°Ð¼ Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð¾Ð¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»Ñ, ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸ÐµÐ¼ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸Ðº, ÑÐ¾Ð²ÐµÑ‚Ð°Ð¼Ð¸ Ð¿Ð¾ Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸ÑŽ, Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾ Ñ†ÐµÐ½Ð°Ñ… Ð¸ Ð¼Ð½Ð¾Ð³Ð¸Ð¼ Ð´Ñ€ÑƒÐ³Ð¸Ð¼. Ð§ÐµÐ¼ Ð¼Ð¾Ð³Ñƒ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ?",
            "Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ ÑƒÐ¼ÐµÐµÑˆÑŒ": "ÐšÐ°Ðº Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚, Ñ ÑƒÐ¼ÐµÑŽ Ð¼Ð½Ð¾Ð³Ð¾Ðµ! ÐœÐ¾Ð³Ñƒ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ð’Ð°Ð¼ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¸Ð´ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑŒ Ð¿Ð¾Ð´ Ð’Ð°ÑˆÐ¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð½Ð¾ÑÑ‚Ð¸ Ð¸ Ð±ÑŽÐ´Ð¶ÐµÑ‚, ÑÑ€Ð°Ð²Ð½Ð¸Ñ‚ÑŒ Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð¼Ð¾Ð´ÐµÐ»Ð¸, Ð´Ð°Ñ‚ÑŒ ÑÐ¾Ð²ÐµÑ‚Ñ‹ Ð¿Ð¾ Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸ÑŽ Ð¸ Ñ€ÐµÐ¼Ð¾Ð½Ñ‚Ñƒ, Ð¿Ð¾Ð´ÑÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ†ÐµÐ½Ð°Ñ… Ð¸ Ñ€Ñ‹Ð½ÐºÐµ, Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ð¸ ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²ÐºÐ¾Ð¹. Ð¢Ð°ÐºÐ¶Ðµ Ð¼Ð¾Ð³Ñƒ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ð½Ð° Ð¾Ð±Ñ‰Ð¸Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð±ÐµÑÐµÐ´Ñƒ. ÐŸÑ€Ð¾ÑÑ‚Ð¾ ÑÐºÐ°Ð¶Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾ Ð’Ð°Ñ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÐµÑ‚!",
            "ÐºÐ°Ðº Ð´ÐµÐ»Ð°": "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾, Ñƒ Ð¼ÐµÐ½Ñ Ð²ÑÐµ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð½Ð¾! Ð“Ð¾Ñ‚Ð¾Ð² Ð¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸. Ð Ñƒ Ð’Ð°Ñ ÐºÐ°Ðº Ð´ÐµÐ»Ð°? Ð•ÑÑ‚ÑŒ Ð»Ð¸ ÐºÐ°ÐºÐ¸Ðµ-Ñ‚Ð¾ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¿Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑÐ¼, Ñ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¼Ð¸ Ð¼Ð¾Ð³Ñƒ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ?"
        }
        
        query_lower = user_query.lower().strip()
        for key, response in fallback_responses.items():
            if key in query_lower:
                return response
        
        return "Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ! Ð¯ Ð°Ð²Ñ‚Ð¾Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ ÐÐÐ ÐœÐžÐ¢ÐžÐ Ð¡. Ð“Ð¾Ñ‚Ð¾Ð² Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ð’Ð°Ð¼ Ñ Ð»ÑŽÐ±Ñ‹Ð¼Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸ Ð¿Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð¾Ð±Ð¸Ð»ÑÐ¼. Ð§Ñ‚Ð¾ Ð’Ð°Ñ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÐµÑ‚?" 

def enforce_formal_address(text: str) -> str:
    """Ð—Ð°Ð¼ÐµÐ½ÑÐµÑ‚ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ Ð½Ð° 'Ñ‚Ñ‹' Ð½Ð° Ñ„Ð¾Ñ€Ð¼Ñ‹ 'Ð’Ñ‹/Ð’Ð°Ñ/Ð’Ð°Ð¼/Ð’Ð°Ñˆ' Ñ Ð¿Ñ€Ð¾Ð¿Ð¸ÑÐ½Ð¾Ð¹."""
    import re
    replacements = [
        (r"\bÑ‚Ñ‹\b", "Ð’Ñ‹"),
        (r"\bÑ‚ÐµÐ±Ñ\b", "Ð’Ð°Ñ"),
        (r"\bÑ‚ÐµÐ±Ðµ\b", "Ð’Ð°Ð¼"),
        (r"\bÑ‚Ð¾Ð±Ð¾Ð¹\b", "Ð’Ð°Ð¼Ð¸"),
        (r"\bÑ Ñ‚Ð¾Ð±Ð¾Ð¹\b", "Ñ Ð’Ð°Ð¼Ð¸"),
        (r"\bÐ´Ð»Ñ Ñ‚ÐµÐ±Ñ\b", "Ð´Ð»Ñ Ð’Ð°Ñ"),
        (r"\bÑ‚Ð²Ð¾Ð¹\b", "Ð’Ð°Ñˆ"),
        (r"\bÑ‚Ð²Ð¾Ñ\b", "Ð’Ð°ÑˆÐ°"),
        (r"\bÑ‚Ð²Ð¾Ðµ\b", "Ð’Ð°ÑˆÐµ"),
        (r"\bÑ‚Ð²Ð¾Ñ‘\b", "Ð’Ð°ÑˆÐµ"),
        (r"\bÑ‚Ð²Ð¾Ð¸\b", "Ð’Ð°ÑˆÐ¸"),
    ]
    result = text
    for pattern, repl in replacements:
        result = re.sub(pattern, repl, result, flags=re.IGNORECASE)
    return result

def _looks_russian(text: str) -> bool:
    """Ð“Ñ€ÑƒÐ±Ð°Ñ ÑÐ²Ñ€Ð¸ÑÑ‚Ð¸ÐºÐ°: Ð² Ð¾Ñ‚Ð²ÐµÑ‚Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÐºÐ¸Ñ€Ð¸Ð»Ð»Ð¸Ñ†Ñ‹."""
    import re
    cyr = len(re.findall(r"[Ð-Ð¯Ð°-ÑÐÑ‘]", text or ""))
    lat = len(re.findall(r"[A-Za-z]", text or ""))
    return cyr >= max(10, lat)