# Исправления в логике маршрутизации запросов

## Проблемы, которые были исправлены

### 1. Неправильная обработка запросов о "лада"
**Проблема:** Запросы типа "лада", "ладу", "лады" не распознавались как автомобильные.

**Решение:** Добавлены российские бренды в список автомобильных ключевых слов:
```python
# Российские бренды
'лада', 'ладу', 'лады', 'ладе', 'ладу', 'ладою', 'лада', 'ваз', 'автоваз', 'lada',
'уаз', 'газ', 'москвич', 'волга', 'жигули', 'нива', 'калина', 'гранта', 'веста',
'приора', 'десять', 'семерка', 'пятерка', 'четверка', 'копейка', 'копейки',
```

### 2. Неправильная отправка общих запросов в Llama
**Проблема:** Запросы типа "у тебя живут рыбки дома", "как тебя зовут", "отслеживаешь ли ты тему нашего общения" обрабатывались как автомобильные.

**Решение:** Добавлены специальные паттерны для общих запросов:
```python
general_patterns = [
    'как тебя зовут', 'отслеживаешь ли ты', 'тему нашего общения',
    'у тебя живут', 'рыбки дома', 'какая марка наиболее быстрая',
    'что ты умеешь', 'расскажи о себе', 'кто ты такой',
    'как дела', 'привет', 'здравствуй'
]
```

### 3. Ошибки асинхронных вызовов
**Проблема:** `asyncio.run()` вызывался из уже запущенного event loop, что вызывало ошибки.

**Решение:** Добавлен синхронный метод `_generate_with_llama_sync()` и заменены асинхронные вызовы на синхронные.

### 4. Улучшенный промпт для Ollama
**Добавлены специальные инструкции для ответов на общие вопросы:**
```python
ОТВЕТЫ НА ОБЩИЕ ВОПРОСЫ:
- Если спрашивают "как тебя зовут" - отвечайте "Меня зовут МОТОРЧИК, я ваш автоассистент"
- Если спрашивают "что ты умеешь" - расскажите о возможностях автоассистента
- Если спрашивают "отслеживаешь ли ты тему нашего общения" - отвечайте "Да, я отслеживаю контекст нашего разговора"
- Если спрашивают о рыбках или домашних животных - отвечайте вежливо, что вы автоассистент
- Если спрашивают "какая марка наиболее быстрая" - расскажите о спортивных автомобилях
```

## Результаты тестирования

Все 23 тестовых запроса обрабатываются корректно:
- ✅ 10 автомобильных запросов (лада, bmw, мерседес и т.д.)
- ✅ 13 общих запросов (рыбки, как тебя зовут, привет и т.д.)

**Точность: 100%**

## Файлы, которые были изменены

1. `smart_query_router.py` - основная логика маршрутизации
2. `enhanced_llama_processor.py` - исправление асинхронных вызовов
3. `test_query_routing.py` - тестовый скрипт для проверки

## Как использовать

1. Запустите тест для проверки логики:
```bash
python test_query_routing.py
```

2. Перезапустите приложение для применения изменений:
```bash
python app.py
```

Теперь запросы будут правильно маршрутизироваться:
- Автомобильные запросы → обработка через поиск и анализ
- Общие запросы → отправка в Llama для генерации ответов 