# üîç –ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ LLAMA

## üìã –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

### 1. **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤**
–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `SmartQueryRouter` –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:

```python
# smart_query_router.py
class SmartQueryRouter:
    def is_car_related(self, query: str) -> bool:
        # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω–æ–π —Ç–µ–º–∞—Ç–∏–∫–∏
        car_keywords = ['–º–∞—à–∏–Ω–∞', '–∞–≤—Ç–æ–º–æ–±–∏–ª—å', 'bmw', 'mercedes', '–Ω–∞–π–¥–∏', '–ø–æ–∫–∞–∂–∏', ...]
        return any(keyword in query.lower() for keyword in car_keywords)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏:**
- **–ê–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** ‚Üí `UniversalQueryProcessor`
- **–û–±—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã** ‚Üí `generate_general_response()` —Å –ø—Ä–æ–º—Ç–æ–º "–ú–æ—Ç–æ—Ä—á–∏–∫"

---

## üöó –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 2. **–õ–æ–∫–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)**

```python
# modules/classifiers/query_processor.py
def process(self, query: str, entities: dict, user_id: str = 'default'):
    # 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ NER
    auto_entities = self.ner_intent.extract_entities(query)
    entities = {**auto_entities, **entities}
    
    # 2. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–Ω—Ç–µ–Ω—Ç–∞
    intent = self.ner_intent.classify_intent(query)
    
    # 3. –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ SearchModule
    local_result = self.search.process(query, entities, context)
    
    # 4. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–µ–∑ LLAMA
    if local_result.get('cars') and len(local_result['cars']) > 0:
        local_result['message'] = '–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞–π–¥–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ LLAMA).'
        return local_result
```

**–î–∞–Ω–Ω—ã–µ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞:**
- **–°—É—â–Ω–æ—Å—Ç–∏ –∏–∑ NER**: brand, model, color, price, year, city, body_type
- **–°–∏–Ω–æ–Ω–∏–º—ã**: —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏ –¥–ª—è –±—Ä–µ–Ω–¥–æ–≤, —Ü–≤–µ—Ç–æ–≤, –≥–æ—Ä–æ–¥–æ–≤
- **–§–∏–ª—å—Ç—Ä—ã**: SQL-–∑–∞–ø—Ä–æ—Å—ã —Å LIKE, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π

---

## ü§ñ –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ LLAMA

### 3. **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LLAMA**

LLAMA –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
1. –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
2. –ó–∞–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç —Å–ª–æ–∂–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
3. –ù—É–∂–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

### 4. **–ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ LLAMA**

#### **–®–∞–≥ 1: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º—Ç–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤**

```python
filter_prompt = (
    "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å: '" + query + "'. "
    "–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª—è –µ—Å—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è: "
    "mark: –º–∞—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, BMW, Toyota); "
    "model: –º–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, X5, Camry); "
    "manufacture_year: –≥–æ–¥ –≤—ã–ø—É—Å–∫–∞; "
    "price: —Ü–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö; "
    "city: –≥–æ—Ä–æ–¥ –ø—Ä–æ–¥–∞–∂–∏; "
    "color: —Ü–≤–µ—Ç –∫—É–∑–æ–≤–∞; "
    "body_type: —Ç–∏–ø –∫—É–∑–æ–≤–∞ (—Å–µ–¥–∞–Ω, –∫—Ä–æ—Å—Å–æ–≤–µ—Ä –∏ —Ç.–¥.); "
    "gear_box_type: —Ç–∏–ø –∫–æ—Ä–æ–±–∫–∏ –ø–µ—Ä–µ–¥–∞—á (–∞–≤—Ç–æ–º–∞—Ç, –º–µ—Ö–∞–Ω–∏–∫–∞ –∏ —Ç.–¥.); "
    "driving_gear_type: —Ç–∏–ø –ø—Ä–∏–≤–æ–¥–∞ (–ø–µ—Ä–µ–¥–Ω–∏–π, –∑–∞–¥–Ω–∏–π, –ø–æ–ª–Ω—ã–π); "
    "engine_vol: –æ–±—ä—ë–º –¥–≤–∏–≥–∞—Ç–µ–ª—è; "
    "power: –º–æ—â–Ω–æ—Å—Ç—å –¥–≤–∏–≥–∞—Ç–µ–ª—è; "
    "fuel_type: —Ç–∏–ø —Ç–æ–ø–ª–∏–≤–∞; "
    "dealer_center: –¥–∏–ª–µ—Ä—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä; "
    "option_description: –æ–ø—Ü–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª—é–∫, –ø–∞–Ω–æ—Ä–∞–º–Ω–∞—è –∫—Ä—ã—à–∞, –∫–∞–±—Ä–∏–æ–ª–µ—Ç). "
    "–ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —ç—Ç–∏ –ø–æ–ª—è. –ï—Å–ª–∏ —Ä–µ—á—å –æ –ª—é–∫–µ, –ø–∞–Ω–æ—Ä–∞–º–Ω–æ–π –∫—Ä—ã—à–µ –∏–ª–∏ –∫–∞–±—Ä–∏–æ–ª–µ—Ç–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–µ option_description —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º ['–ª—é–∫', '–ø–∞–Ω–æ—Ä–∞–º–Ω–∞—è –∫—Ä—ã—à–∞', '–æ—Ç–∫—Ä—ã–≤–∞—é—â–∞—è—Å—è –∫—Ä—ã—à–∞']. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ. "
    "–°—Ñ–æ—Ä–º–∏—Ä—É–π —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π. –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ JSON, –Ω–∞–ø—Ä–∏–º–µ—Ä: "
    '{"body_type": "–∫—Ä–æ—Å—Å–æ–≤–µ—Ä", "option_description": ["–ª—é–∫", "–ø–∞–Ω–æ—Ä–∞–º–Ω–∞—è –∫—Ä—ã—à–∞"]}. '
    "–ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã ‚Äî –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç–æ–π JSON {}."
)
```

#### **–®–∞–≥ 2: –í—ã–∑–æ–≤ LLAMA –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤**

```python
# llama_service.py
def generate_with_llama(prompt: str, context: Optional[Dict] = None) -> str:
    payload = {
        "model": "llama3:8b",
        "prompt": prompt,
        "stream": False
    }
    
    # Retry –ª–æ–≥–∏–∫–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ URL
    for url in LLAMA_URLS:  # ["http://127.0.0.1:11434/api/generate", "http://localhost:11434/api/generate"]
        for attempt in range(RETRY_ATTEMPTS):  # 3 –ø–æ–ø—ã—Ç–∫–∏
            try:
                response = requests.post(url, json=payload, timeout=90)
                if response.status_code == 200:
                    result = response.json()
                    return result.get("response", "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å...")
            except Exception as e:
                time.sleep(RETRY_BASE_DELAY * (2 ** attempt))  # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
```

#### **–®–∞–≥ 3: –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ LLAMA**

```python
try:
    llama_filters = generate_with_llama(filter_prompt)
    filters = json.loads(llama_filters.strip().split('```')[-1] if '```' in llama_filters else llama_filters)
except Exception:
    filters = {}
```

#### **–®–∞–≥ 4: –ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤**

```python
# –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
if isinstance(filters, dict):
    for key in list(filters.keys()):
        if key.lower() in ["open_roof", "roof_type", "roof_open"] or (
            isinstance(filters[key], str) and "–æ—Ç–∫—Ä—ã—Ç" in filters[key].lower()
        ):
            filters["option_description"] = ['–ª—é–∫', '–ø–∞–Ω–æ—Ä–∞–º–Ω–∞—è –∫—Ä—ã—à–∞', '–æ—Ç–∫—Ä—ã–≤–∞—é—â–∞—è—Å—è –∫—Ä—ã—à–∞']
            del filters[key]

# –ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π
mapping = {
    'brand': 'brand', 'mark': 'brand', 'model': 'model', 'body_type': 'body_type',
    'year_from': 'year_from', 'year_to': 'year_to', 'price_from': 'price_from', 'price_to': 'price_to',
    'fuel_type': 'fuel_type', 'transmission': 'transmission', 'gear_box_type': 'transmission',
    'drive_type': 'drive_type', 'city': 'city', 'option': 'option_description', 'options': 'option_description'
}
```

#### **–®–∞–≥ 5: –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**

```python
# –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã–±–æ—Ä–∫—É –¥–ª—è LLAMA
cars = search_all_cars(**search_kwargs, limit=50)

# –ü–µ—Ä–µ–¥–∞–µ–º LLAMA —Ç–æ–ª—å–∫–æ 5 –º–∞—à–∏–Ω
cars_str = '\n'.join([
    f"{c.get('mark','')} {c.get('model','')} {c.get('manufacture_year','')} {c.get('body_type','')} {c.get('price','')} {c.get('city','')}"
    for c in cars[:5]
])
```

#### **–®–∞–≥ 6: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞**

```python
prompt = (
    "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å: '" + query + "'. –í–æ—Ç —Å–ø–∏—Å–æ–∫ –º–∞—à–∏–Ω –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º:\n"
    f"{cars_str}\n"
    "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∏ —Ç–æ–ª—å–∫–æ –ø–æ —ç—Ç–∏–º –¥–∞–Ω–Ω—ã–º. "
    "–ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç ‚Äî —Å–∫–∞–∂–∏, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. "
    "–°—Ñ–æ—Ä–º–∏—Ä—É–π –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
)

final_response = generate_with_llama(prompt)
```

---

## üí¨ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 5. **–ü—Ä–æ–º—Ç "–ú–æ—Ç–æ—Ä—á–∏–∫"**

```python
# llama_service.py
MOTORCHIK_PROMPT = """
–¢—ã - –ú–æ—Ç–æ—Ä—á–∏–∫, —É–º–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è –ø–æ–º–æ—â–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏, –ø–æ–∫—É–ø–∫–æ–π, –ø—Ä–æ–¥–∞–∂–µ–π, –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ–º –∏ –≤—Å–µ–º, —á—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω–æ–π —Ç–µ–º–∞—Ç–∏–∫–∏.

## –¢–≤–æ—è —Ä–æ–ª—å –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

### üöó –û—Å–Ω–æ–≤–Ω–∞—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:
- –ü–æ–º–æ—â—å –≤ –≤—ã–±–æ—Ä–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –º–∞—à–∏–Ω
- –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –ø–æ–∫—É–ø–∫–µ –∏ –ø—Ä–æ–¥–∞–∂–µ
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏ –∏ —Ä–µ–º–æ–Ω—Ç–µ
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–∞ –¥–æ—Ä–æ–≥–µ
- –°–æ–≤–µ—Ç—ã –ø–æ —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–ø–ª–∏–≤–∞
- –ü–æ–º–æ—â—å —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –∏ —Å—Ç—Ä–∞—Ö–æ–≤–∫–æ–π

### üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
- –°–æ–≤–µ—Ç—ã –ø–æ —É—Ö–æ–¥—É –∑–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–º
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–≤—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö –≤ –∞–≤—Ç–æ–∏–Ω–¥—É—Å—Ç—Ä–∏–∏
- –ü–æ–º–æ—â—å —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ–µ–∑–¥–æ–∫

## –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π
- –ü–æ–ª–µ–∑–Ω—ã–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π
- –¢–µ—Ä–ø–µ–ª–∏–≤—ã–π –≤ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è—Ö
- –ü–æ–æ—â—Ä—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å—ã –∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è
- –í—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å

## –ü—Ä–∞–≤–∏–ª–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è –∫–∞–∫ –ú–æ—Ç–æ—Ä—á–∏–∫
- –ü—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–æ–º–æ—â—å
- –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
- –°—Å—ã–ª–∞–π—Å—è –Ω–∞ —Å–≤–æ—é —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
"""
```

### 6. **Fallback –æ—Ç–≤–µ—Ç—ã**

```python
fallback_responses = {
    "–ø—Ä–∏–≤–µ—Ç": "–ü—Ä–∏–≤–µ—Ç! –Ø –ú–æ—Ç–æ—Ä—á–∏–∫, —Ç–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º - –æ—Ç –≤—ã–±–æ—Ä–∞ –º–∞—à–∏–Ω—ã –¥–æ —Å–æ–≤–µ—Ç–æ–≤ –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é. –ß—Ç–æ —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?",
    "–∫—Ç–æ —Ç—ã": "–Ø –ú–æ—Ç–æ—Ä—á–∏–∫ - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω–æ–π —Ç–µ–º–∞—Ç–∏–∫–∏. –ú–æ—è –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ–≥–∞—Ç—å –ª—é–¥—è–º —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ —Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏...",
    "—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å": "–ö–∞–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —è —É–º–µ—é –º–Ω–æ–≥–æ–µ! –ú–æ–≥—É –ø–æ–º–æ—á—å –Ω–∞–π—Ç–∏ –∏–¥–µ–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –ø–æ–¥ —Ç–≤–æ–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∏ –±—é–¥–∂–µ—Ç...",
    "–∫–∞–∫ –¥–µ–ª–∞": "–°–ø–∞—Å–∏–±–æ, —É –º–µ–Ω—è –≤—Å–µ –æ—Ç–ª–∏—á–Ω–æ! –ì–æ—Ç–æ–≤ –ø–æ–º–æ–≥–∞—Ç—å —Å –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏..."
}
```

---

## üìä –î–∞–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ LLAMA

### 7. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –±–∞–∑—ã**

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è:**
- `mark` - –º–∞—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è (BMW, Toyota, Mercedes)
- `model` - –º–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è (X5, Camry, GLE)
- `manufacture_year` - –≥–æ–¥ –≤—ã–ø—É—Å–∫–∞
- `price` - —Ü–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö
- `city` - –≥–æ—Ä–æ–¥ –ø—Ä–æ–¥–∞–∂–∏
- `color` - —Ü–≤–µ—Ç –∫—É–∑–æ–≤–∞
- `body_type` - —Ç–∏–ø –∫—É–∑–æ–≤–∞ (—Å–µ–¥–∞–Ω, –∫—Ä–æ—Å—Å–æ–≤–µ—Ä, SUV)
- `gear_box_type` - —Ç–∏–ø –∫–æ—Ä–æ–±–∫–∏ –ø–µ—Ä–µ–¥–∞—á
- `driving_gear_type` - —Ç–∏–ø –ø—Ä–∏–≤–æ–¥–∞
- `engine_vol` - –æ–±—ä—ë–º –¥–≤–∏–≥–∞—Ç–µ–ª—è
- `power` - –º–æ—â–Ω–æ—Å—Ç—å –¥–≤–∏–≥–∞—Ç–µ–ª—è
- `fuel_type` - —Ç–∏–ø —Ç–æ–ø–ª–∏–≤–∞
- `dealer_center` - –¥–∏–ª–µ—Ä—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä
- `option_description` - –æ–ø—Ü–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è

### 8. **–°–∏–Ω–æ–Ω–∏–º—ã –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è**

**–¶–≤–µ—Ç–∞:**
```python
COLOR_SYNONYMS = {
    '–∫—Ä–∞—Å–Ω—ã–π': ['–∫—Ä–∞—Å–Ω—ã–π', '–ö—Ä–∞—Å–Ω—ã–π', 'red', 'Red', '–æ–≥–Ω–µ–Ω–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π', 'fire red', ...],
    '—Å–∏–Ω–∏–π': ['—Å–∏–Ω–∏–π', '–°–∏–Ω–∏–π', 'blue', 'Blue', '–≥–æ–ª—É–±–æ–π', '–ì–æ–ª—É–±–æ–π', 'navy blue', ...],
    # ... –¥—Ä—É–≥–∏–µ —Ü–≤–µ—Ç–∞
}
```

**–ì–æ—Ä–æ–¥–∞:**
```python
CITY_SYNONYMS = {
    "–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É": ['—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É', '—Ä–æ—Å—Ç–æ–≤', '—Ä–æ—Å—Ç–æ–≤–µ', 'rostov', 'rostov-on-don', ...],
    "–í–æ—Ä–æ–Ω–µ–∂": ['–≤–æ—Ä–æ–Ω–µ–∂', '–≤–æ—Ä–æ–Ω–µ–∂–µ', 'voronezh', 'voroneje', ...],
    "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä": ['–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä', '–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ', 'krasnodar', 'krasnodare', ...]
}
```

**–ë—Ä–µ–Ω–¥—ã:**
```python
BRAND_SYNONYMS = {
    "BMW": ['bmw', '–±–º–≤', 'BMW', '–ë–ú–í'],
    "Mercedes": ['mercedes', '–º–µ—Ä—Å–µ–¥–µ—Å', 'mercedes-benz', '–º–µ—Ä—Å–µ–¥–µ—Å-–±–µ–Ω—Ü'],
    "Lada": ['lada', '–ª–∞–¥–∞', '–≤–∞–∑', '–í–ê–ó']
}
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### 9. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è LLAMA**

```python
# llama_service.py
LLAMA_URLS = [
    "http://127.0.0.1:11434/api/generate",
    "http://localhost:11434/api/generate"
]
RETRY_ATTEMPTS = 3
RETRY_BASE_DELAY = 2  # seconds

payload = {
    "model": "llama3:8b",
    "prompt": prompt,
    "stream": False
}
```

### 10. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

```python
def generate_with_llama(prompt: str, context: Optional[Dict] = None) -> str:
    last_error = None
    for url in LLAMA_URLS:
        for attempt in range(RETRY_ATTEMPTS):
            try:
                response = requests.post(url, json=payload, timeout=90)
                if response.status_code == 200:
                    result = response.json()
                    return result.get("response", "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å...")
                else:
                    last_error = f"–û—à–∏–±–∫–∞ Llama API: {response.status_code} ({url})"
            except Exception as e:
                last_error = f"{e} ({url})"
            time.sleep(RETRY_BASE_DELAY * (2 ** attempt))
    
    # Fallback: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Ç–æ—á–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã..."
```

### 11. **–ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤**

```python
def postprocess_llama_response(text):
    """–ó–∞–º–µ–Ω—è–µ—Ç –∫–æ–¥—ã –æ–ø—Ü–∏–π –≤–∏–¥–∞ `optXXXX` –Ω–∞ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑ –±–∞–∑—ã."""
    import re
    from database import get_all_options
    options = get_all_options()
    code2desc = {o['code']: o['description'] for o in options if o['code']}
    def repl(match):
        code = match.group(1)
        desc = code2desc.get(code)
        return f"`{desc}`" if desc else f"`{code}`"
    return re.sub(r'`(opt\d{4,})`', repl, text)
```

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 12. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏**

1. **–õ–æ–∫–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
   - NER –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π
   - –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
   - –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –±–µ–∑ LLAMA

2. **LLAMA –æ–±—Ä–∞–±–æ—Ç–∫–∞** (fallback)
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
   - –ü–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

3. **–û–±—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã**
   - –ü—Ä–æ–º—Ç "–ú–æ—Ç–æ—Ä—á–∏–∫"
   - Fallback –æ—Ç–≤–µ—Ç—ã

### 13. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**

- **–õ–∏–º–∏—Ç –º–∞—à–∏–Ω –¥–ª—è LLAMA**: 50 –¥–ª—è –ø–æ–∏—Å–∫–∞, 5 –¥–ª—è –ø—Ä–æ–º—Ç–∞
- **–¢–∞–π–º–∞—É—Ç**: 90 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–ø—Ä–æ—Å
- **Retry –ª–æ–≥–∏–∫–∞**: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- **Fallback URLs**: 2 –∞–¥—Ä–µ—Å–∞ –¥–ª—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
         ‚Üì
SmartQueryRouter (–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è)
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ê–≤—Ç–æ–º–æ–±–∏–ª—å–Ω—ã–π   ‚îÇ –û–±—â–∏–π –∑–∞–ø—Ä–æ—Å    ‚îÇ
‚îÇ –∑–∞–ø—Ä–æ—Å          ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì                    ‚Üì
UniversalQueryProcessor    generate_general_response()
         ‚Üì                    ‚Üì
1. NER –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ           MOTORCHIK_PROMPT
2. –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫          ‚Üì
3. –ï—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Üí   LLAMA (llama3:8b)
   LLAMA –æ–±—Ä–∞–±–æ—Ç–∫–∞          ‚Üì
         ‚Üì              Fallback –æ—Ç–≤–µ—Ç—ã
–†–µ–∑—É–ª—å—Ç–∞—Ç —Å –º–∞—à–∏–Ω–∞–º–∏
```

–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- **–ë—ã—Å—Ç—Ä—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É** —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏
- **–ì–∏–±–∫–æ—Å—Ç—å** —á–µ—Ä–µ–∑ LLAMA –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** —á–µ—Ä–µ–∑ fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã
- **–ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤** —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–º—Ç—ã 